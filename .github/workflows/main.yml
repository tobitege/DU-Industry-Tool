on:
    push:
        branches:
            - master
        paths-ignore:
            - '.git*'
            - '.vscode'
            #- '.github/**/*.yml'

permissions:
    contents: write

jobs:
    build:
        runs-on: windows-2022
        steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Setup MSBuild
          uses: microsoft/setup-msbuild@v1

        - name: Setup NuGet
          uses: NuGet/setup-nuget@v1.0.6

        - name: Navigate to Workspace
          run: cd $GITHUB_WORKSPACE

        - name: Get Assembly Version
          id: getversion
          uses: berglie/assembly-version/get@v1
          with:
            filename: Version.txt
            directory: './DU-Industry-Tool'

        - name: Restore Packages
          run: nuget restore DU-Industry-Tool.sln

        - name: Build Solution
          run: |
            msbuild.exe DU-Industry-Tool.sln /p:platform="Any CPU" /p:configuration="Release"

        - name: Check if release already exists
          if: ${{ (github.ref == 'refs/heads/master') }}  # ONLY ON MASTER
          id: release_guard
          shell: pwsh
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            $tag = "v${{ steps.getversion.outputs.version }}"
            $url = "https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag"
            $headers = @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
            }

            try {
              Invoke-RestMethod -Uri $url -Headers $headers -Method Get | Out-Null
              "should_release=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
              Write-Host "Release for tag $tag already exists. Skipping archive/release steps."
            }
            catch {
              $statusCode = $null
              if ($_.Exception.Response -and $_.Exception.Response.StatusCode) {
                $statusCode = [int]$_.Exception.Response.StatusCode
              }

              if ($statusCode -eq 404) {
                "should_release=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
                Write-Host "No release found for tag $tag. Archive/release steps will run."
              }
              else {
                throw
              }
            }

        - name: Archive Release
          if: ${{ (github.ref == 'refs/heads/master') && steps.release_guard.outputs.should_release == 'true' }}  # ONLY ON MASTER + NEW RELEASE
          uses: thedoctor0/zip-release@main
          with:
            directory: DU-Industry-Tool/bin/Release/
            type: 'zip'
            filename: DU-Industry-Tool-v${{ steps.getversion.outputs.version }}.zip
            exclusions: '*.git* /*node_modules/* *.xml *.pdb *.vs* *.user .editorconfig'

        - name: Create and upload GitHub Release
          if: ${{ (github.ref == 'refs/heads/master') && steps.release_guard.outputs.should_release == 'true' }}  # ONLY ON MASTER + NEW RELEASE
          uses: softprops/action-gh-release@v2
          with:
            tag_name: v${{ steps.getversion.outputs.version }}
            name: DU-Industry-Tool-v${{ steps.getversion.outputs.version }}
            draft: false
            prerelease: false
            body_path: DU-Industry-Tool/latestchanges.md
            files: DU-Industry-Tool/bin/Release/DU-Industry-Tool-v${{ steps.getversion.outputs.version }}.zip
